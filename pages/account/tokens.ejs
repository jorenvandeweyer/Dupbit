<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include ../components/head %>
    </head>
    <body>
        <%- include ../components/header %>
        <br>

        <div class="container">
			<div class="card">
				<div class="card-header"><b>Manage Tokens</b></div>
				<div class="card-body">
					<table class='table table-hover'>
						<thead>
                            <tr>
                                <th>ID</th>
                                <th>Info</th>
                                <th>Device</th>
                                <th>IP</th>
                                <th>Created</th>
                                <th>Delete</th>
                            </tr>
						</thead>
						<tbody id="tokens">
						</tbody>
					</table>
				</div>
			</div>
		</div>

        <%- include ../components/footer %>
    </body>

    <script>
    async function fetchDevices() {
        return new Promise((resolve, reject) => {
            $.get("/api/connect/devices", (data) => {
                if (data.success) {
                    resolve([data.data, data.tokens]);
                } else {
                    reject("error fetching devices");
                }
            });
        });
    }

    async function main() {
        const [devices, tokens] = await fetchDevices()

        const html_tokens = createHTMLTokens(tokens);

        document.getElementById("tokens").innerHTML = html_tokens;
    }

    function createHTMLTokens(tokens) {
        console.log(tokens);
        return tokens.map(createTokenRow).join("");
    }

    function createTokenRow(token) {
        return `<tr id="token_${token.id}">
                <td>${token.id}</td>
                <td>${token.name}</td>
                <td>${token.device}</td>
                <td>${token.ip}</td>
                <td>${token.timestamp}</td>
                <td><button type='button' class='btn btn-danger' onclick='deleteToken(${token.id})'>Revoke</button></td>
                </tr>`;
    }

    function deleteToken(tid) {
        $.get(`/api/account/removeToken?tid=${tid}`, (data) => {
            if (data.success) {
                document.getElementById(`token_${tid}`).outerHTML = "";
            } else {
                alert(`Please take contact with the website owner and provide the error string\nError: removeToken?tid=${tid} success=false`);
            }
        });
    }

    main();
    </script>

</html>
